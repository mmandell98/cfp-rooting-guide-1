'use client';import React, { useEffect, useMemo, useState } from 'react';import { computeGuide, type Ranking, type Game } from '@/lib/heuristic';/** ---------- Types & constants ---------- **/// Strict union type for the objective (matches what computeGuide expects)type Objective = 'Make CFP' | 'Top 12 Seed' | 'Win Conference';const OBJECTIVES: Objective[] = ['Make CFP', 'Top 12 Seed', 'Win Conference'];// Poll uniontype Poll = 'Playoff Committee' | 'AP Top 25';const TEAM_COLORS: Record<string, string> = {  Georgia: '#BA0C2F', Texas: '#BF5700', 'Ohio State': '#BB0000', 'Florida State': '#782F40',  Oregon: '#154733', Utah: '#CC0000', 'Penn State': '#1E407C', Alabama: '#9E1B32', LSU: '#461D7C',  'Notre Dame': '#0C2340', USC: '#990000', UVA: '#232D4B', UNC: '#7BAFD4', Oklahoma: '#841617',  'Kansas State': '#512888', Louisville: '#AD0000'};// Simple localStorage wrapperconst store = {  get<T>(k: string, fallback: T): T {    try {      const v = typeof window !== 'undefined' ? window.localStorage.getItem(k) : null;      return v ? (JSON.parse(v) as T) : fallback;    } catch {      return fallback;    }  },  set(k: string, v: unknown) {    try {      if (typeof window !== 'undefined') window.localStorage.setItem(k, JSON.stringify(v));    } catch {}  },};// Validate a stored value against OBJECTIVES; default to 'Make CFP'function getInitialObjective(): Objective {  const raw = store.get<string>('cfp.objective', 'Make CFP');  return (OBJECTIVES as readonly string[]).includes(raw) ? (raw as Objective) : 'Make CFP';}/** ---------- Page Component ---------- **/export default function Page() {  // Core preferences  const [favorite, setFavorite] = useState(store.get('cfp.favorite', 'UVA'));  const [objective, setObjective] = useState<Objective>(getInitialObjective());  const [chaos, setChaos] = useState<number>(store.get('cfp.chaos', 70));  const [sos, setSos] = useState<number>(store.get('cfp.sos', 40));  const [confBias, setConfBias] = useState<number>(store.get('cfp.confBias', 60));  // Week/poll controls  const [year, setYear] = useState<number>(new Date().getFullYear());  const [week, setWeek] = useState<string>(''); // empty = all weeks  const [seasonType, setSeasonType] = useState<'regular' | 'postseason' | 'both'>('regular');  const [poll, setPoll] = useState<Poll>(store.get<Poll>('cfp.poll', 'AP Top 25'));  // Data  const [weeks, setWeeks] = useState<{ week: number; start: string; end: string }[]>([]);  const [currentWeek, setCurrentWeek] = useState<number | null>(null);  const [rankings, setRankings] = useState<Ranking[]>([]);  const [games, setGames] = useState<Game[]>([]);  const [teams, setTeams] = useState<Record<string, { logos?: string[] }>>({});  const [note, setNote] = useState<string | undefined>();  // Opponents already played  const [opponentsText, setOpponentsText] = useState(store.get('cfp.opps', 'UNC, Louisville, Notre Dame'));  const opponentsPlayed = useMemo(    () => opponentsText.split(',').map((s) => s.trim()).filter(Boolean),    [opponentsText]  );  /** ---------- Persist user prefs ---------- **/  useEffect(() => { store.set('cfp.favorite', favorite); }, [favorite]);  useEffect(() => { store.set('cfp.objective', objective); }, [objective]);  useEffect(() => { store.set('cfp.chaos', chaos); }, [chaos]);  useEffect(() => { store.set('cfp.sos', sos); }, [sos]);  useEffect(() => { store.set('cfp.confBias', confBias); }, [confBias]);  useEffect(() => { store.set('cfp.opps', opponentsText); }, [opponentsText]);  useEffect(() => { store.set('cfp.poll', poll); }, [poll]);  /** ---------- Fetch data from our API routes ---------- **/  async function loadData() {    const [rRes, gRes, tRes, wRes] = await Promise.all([      fetch(`/api/rankings?year=${year}&week=${week}&seasonType=${seasonType}&poll=${encodeURIComponent(poll)}`).then((r) => r.json()),      fetch(`/api/games?year=${year}&week=${week}&seasonType=${seasonType}`).then((r) => r.json()),      fetch(`/api/teams?year=${year}`).then((r) => r.json()).catch(() => ({ teams: [] })),      fetch(`/api/weeks?year=${year}&seasonType=${seasonType}`).then((r) => r.json()).catch(() => ({ weeks: [] })),    ]);    setRankings((rRes.rankings || []) as Ranking[]);    setGames(((gRes.games || []) as any[]).map((g) => ({      home: g.home, away: g.away, conference: g.conference, week: g.week    })));    setNote(rRes.note);    const map: Record<string, { logos?: string[] }> = {};    (tRes.teams || []).forEach((t: any) => { map[t.school] = { logos: t.logos }; });    setTeams(map);    const wk = (wRes.weeks || []) as { week: number; firstGameStart?: string; lastGameStart?: string; first_game_start?: string; last_game_start?: string }[];    const normalized = wk.map((w) => ({      week: w.week,      start: w.firstGameStart || (w as any)['first_game_start'] || '',      end: w.lastGameStart || (w as any)['last_game_start'] || '',    }));    setWeeks(normalized);    const nowIso = new Date().toISOString();    const current = normalized.find((w) => (w.start && w.end) ? (w.start <= nowIso && nowIso <= w.end) : false);    setCurrentWeek(current?.week ?? null);  }  useEffect(() => { loadData(); }, [year, week, seasonType, poll]);  /** ---------- Compute rooting guide ---------- **/  const guide = useMemo(() => computeGuide({    favorite,    // The strict Objective union keeps TS happy; objective is already Objective, this is extra explicit.    objective: objective as Objective,    chaosLevel: chaos,    sosWeight: sos,    confBias,    schedule: games,    rankings,    opponentsPlayed,    confMap: Object.fromEntries(rankings.map((r) => [r.team, r.conference || ''])),  }), [favorite, objective, chaos, sos, confBias, games, rankings, opponentsPlayed]);  /** ---------- Derived lists ---------- **/  const allTeams = useMemo(() => {    const set = new Set<string>();    rankings.forEach((r) => set.add(r.team));    games.forEach((g) => { set.add(g.home); set.add(g.away); });    return Array.from(set).sort();  }, [rankings, games]);  const futureWeeks = useMemo(() => {    if (!weeks.length) return [] as typeof weeks;    const nowW = currentWeek ?? -Infinity;    return weeks.filter((w) => w.week >= nowW);  }, [weeks, currentWeek]);  /** ---------- Week helpers ---------- **/  function resetToCurrentWeek() {    if (!weeks.length) return;    if (currentWeek) { setWeek(String(currentWeek)); return; }    const fw = futureWeeks[0] || weeks[0];    if (fw) setWeek(String(fw.week));  }  function jumpToNextWeek() {    if (!weeks.length) return;    const nowW = week ? parseInt(week, 10) : (currentWeek ?? weeks[0]?.week);    if (!nowW) { resetToCurrentWeek(); return; }    const sorted = [...weeks].sort((a, b) => a.week - b.week);    const idx = sorted.findIndex((w) => w.week === nowW);    const next = idx >= 0 ? sorted[idx + 1] : undefined;    if (next) setWeek(String(next.week));  }  /** ---------- UI ---------- **/  return (    <div className="min-h-screen">      <header style={{ position: 'sticky', top: 0, background: 'rgba(255,255,255,.9)', backdropFilter: 'saturate(1.2) blur(6px)', borderBottom: '1px solid #eee', zIndex: 10 }}>        <div style={{ maxWidth: 1100, margin: '0 auto', padding: '12px 16px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>            <div style={{ width: 36, height: 36, borderRadius: 12, background: '#4f46e5', color: '#fff', display: 'grid', placeItems: 'center', fontWeight: 700 }}>CFP</div>            <h1 style={{ fontSize: 20, fontWeight: 600 }}>Rooting Guide</h1>          </div>          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>            <a href="/about" style={{ fontSize: 12, color: '#111', textDecoration: 'none', border: '1px solid #eee', borderRadius: 999, padding: '6px 10px' }}>About</a>            <div style={{ fontSize: 12, color: '#666' }}>Live data via CFBD</div>          </div>        </div>      </header>      <main style={{ maxWidth: 1100, margin: '0 auto', padding: 16, display: 'grid', gap: 24, gridTemplateColumns: '1fr', alignItems: 'start' }}>        {/* Controls */}        <section style={{ border: '1px solid #eee', borderRadius: 16, padding: 16 }}>          <h2 style={{ fontWeight: 600, marginBottom: 12 }}>Your Team & Goal</h2>          <label style={{ fontSize: 14, fontWeight: 600 }}>Favorite team</label>          <input            list="teams"            value={favorite}            onChange={(e) => setFavorite(e.target.value)}            placeholder="e.g., UVA"            style={{ width: '100%', border: '1px solid #ddd', borderRadius: 12, padding: '8px 10px', marginTop: 4, marginBottom: 8 }}          />          <datalist id="teams">{allTeams.map((t) => <option key={t} value={t} />)}</datalist>          <label style={{ fontSize: 14, fontWeight: 600 }}>Objective</label>          <select            value={objective}            onChange={(e) => setObjective(e.target.value as Objective)}            style={{ width: '100%', border: '1px solid #ddd', borderRadius: 12, padding: '8px 10px', marginTop: 4, marginBottom: 8 }}          >            {OBJECTIVES.map((o) => <option key={o} value={o}>{o}</option>)}          </select>          {/* Poll switcher */}          <label style={{ fontSize: 14, fontWeight: 600 }}>Poll</label>          <div style={{ display: 'flex', gap: 8, margin: '4px 0 8px' }}>            {(['Playoff Committee', 'AP Top 25'] as const).map((p) => (              <button                key={p}                onClick={() => setPoll(p)}                style={{                  padding: '6px 10px',                  border: '1px solid #ddd',                  borderRadius: 999,                  background: poll === p ? '#111' : '#fff',                  color: poll === p ? '#fff' : '#111',                  fontSize: 13                }}              >                {p === 'Playoff Committee' ? 'CFP' : 'AP'}              </button>            ))}          </div>          {note && (            <div style={{ fontSize: 12, color: '#555', background: '#fff7ed', border: '1px solid #ffedd5', padding: '6px 10px', borderRadius: 12 }}>              ?? {note}            </div>          )}          {/* Week selector (supports future weeks) */}          <div style={{ marginTop: 8 }}>            <label style={{ fontSize: 14, fontWeight: 600 }}>Week</label>            <div style={{ display: 'grid', gridTemplateColumns: '1fr auto auto', gap: 8, alignItems: 'center', marginTop: 4 }}>              <select                value={week}                onChange={(e) => setWeek(e.target.value)}                style={{ width: '100%', border: '1px solid #ddd', borderRadius: 12, padding: '8px 10px' }}              >                <option value="">All weeks</option>                {futureWeeks.map((w) => (                  <option key={w.week} value={String(w.week)}>                    Week {w.week}{w.start && w.end ? ` (${fmtDate(w.start)} Ñ ${fmtDate(w.end)})` : ''}                  </option>                ))}                {weeks.filter((w) => !futureWeeks.find((f) => f.week === w.week)).map((w) => (                  <option key={`past-${w.week}`} value={String(w.week)}>                    Week {w.week}{w.start && w.end ? ` (${fmtDate(w.start)} Ñ ${fmtDate(w.end)})` : ''} Ñ past                  </option>                ))}              </select>              <button onClick={() => resetToCurrentWeek()} style={{ padding: '8px 10px', border: '1px solid #ddd', borderRadius: 12, background: '#fff' }}>Current week</button>              <button onClick={() => jumpToNextWeek()} style={{ padding: '8px 10px', border: '1px solid #ddd', borderRadius: 12, background: '#fff' }}>Next week ?</button>            </div>          </div>          <Slider label="Chaos preference (upsets)" value={chaos} setValue={setChaos} />          <Slider label="Strength of schedule boost" value={sos} setValue={setSos} />          <Slider label="Conference bias (down-weight rivals)" value={confBias} setValue={setConfBias} />          <div style={{ marginTop: 12 }}>            <label style={{ fontSize: 14, fontWeight: 600 }}>Opponents you already played</label>            <input              value={opponentsText}              onChange={(e) => setOpponentsText(e.target.value)}              placeholder="UNC, Louisville, Notre Dame"              style={{ width: '100%', border: '1px solid #ddd', borderRadius: 12, padding: '8px 10px', marginTop: 4 }}            />          </div>        </section>        {/* Guide list */}        <section style={{ border: '1px solid #eee', borderRadius: 16, padding: 16 }}>          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>            <h2 style={{ fontWeight: 600 }}>This Week's Rooting Guide</h2>            <div style={{ fontSize: 13, color: '#666' }}>              Configured for <b>{favorite}</b> á Goal: <b>{objective}</b> á Poll:{' '}              <b>{poll === 'Playoff Committee' ? 'CFP' : 'AP'}</b>            </div>          </div>          <ul style={{ marginTop: 12 }}>            {guide.map((g: any, i: number) => (              <li key={`${g.home}-${g.away}-${i}`} style={{ padding: '16px 0', borderTop: i ? '1px solid #eee' : 'none' }}>                <div style={{ display: 'flex', alignItems: 'flex-start', gap: 12 }}>                  <div style={{ flex: 1 }}>                    <div style={{ display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap' }}>                      <TeamBadge name={g.away} logos={teams[g.away]?.logos} />                      <span style={{ color: '#666', fontSize: 13 }}>at</span>                      <TeamBadge name={g.home} logos={teams[g.home]?.logos} />                      <span style={{ marginLeft: 'auto', fontSize: 11, background: '#f6f7f8', border: '1px solid #eee', padding: '4px 8px', borderRadius: 999 }}>                        Week {g.week}                      </span>                    </div>                    <div style={{ marginTop: 8 }}>                      <div style={{ fontSize: 13, color: '#666' }}>Recommendation</div>                      <div style={{ display: 'inline-flex', gap: 8, alignItems: 'center', background: '#ecfdf5', border: '1px solid #a7f3d0', padding: '6px 10px', borderRadius: 999, marginTop: 4 }}>                        <span style={{ color: '#065f46', fontWeight: 600, fontSize: 14 }}>Root for {g.pick}</span>                        <span style={{ fontSize: 10, background: '#d1fae5', padding: '2px 6px', borderRadius: 999 }}>score {Math.round(g.score)}</span>                      </div>                      <ul style={{ marginTop: 8 }}>                        {g.reasons.map((r: string, idx: number) => (                          <li key={idx} style={{ display: 'flex', gap: 8, fontSize: 14, color: '#333' }}>                            <span style={{ marginTop: 8, width: 6, height: 6, background: '#ccc', borderRadius: 999 }} />                            <span>{r}</span>                          </li>                        ))}                      </ul>                    </div>                  </div>                </div>              </li>            ))}          </ul>          {!guide.length && <div style={{ fontSize: 14, color: '#666' }}>No games found Ñ pick a different week or season type.</div>}        </section>      </main>    </div>  );}/** ---------- Helpers & small components ---------- **/function fmtDate(iso: string) {  try {    const d = new Date(iso);    const mo = d.toLocaleString(undefined, { month: 'short' });    return `${mo} ${d.getDate()}`;  } catch {    return '';  }}function Slider({ label, value, setValue }: { label: string; value: number; setValue: (n: number) => void }) {  return (    <div style={{ marginTop: 8 }}>      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>        <label style={{ fontSize: 14, fontWeight: 600 }}>{label}</label>        <span style={{ fontSize: 12, color: '#666' }}>{value}</span>      </div>      <input type="range" min={0} max={100} value={value} onChange={(e) => setValue(parseInt(e.target.value, 10))} style={{ width: '100%' }} />    </div>  );}function TeamBadge({ name, size = 36, logos }: { name: string; size?: number; logos?: string[] }) {  const initials = name.split(' ').map((w) => w[0]).join('').slice(0, 3).toUpperCase();  const bg = TEAM_COLORS[name] || '#e5e7eb';  const logo = logos && logos.length ? logos[0] : '';  return (    <div title={name} style={{ display: 'inline-flex', alignItems: 'center' }}>      {logo ? (        <img src={logo} alt={`${name} logo`} style={{ width: size, height: size, borderRadius: 999, objectFit: 'contain', background: '#fff', border: '1px solid #eee' }} />      ) : (        <div style={{ width: size, height: size, background: bg, color: '#fff', borderRadius: 999, display: 'grid', placeItems: 'center', fontWeight: 600, boxShadow: '0 1px 2px rgba(0,0,0,.08)' }}>          {initials}        </div>      )}      <span style={{ marginLeft: 8, fontSize: 14, color: '#111' }}>{name}</span>    </div>  );}